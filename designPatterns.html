<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #show {
            width: 100px;
            height: 100px;
            border: 1px solid #000;
        }
        span {
            color: red;
        }
    </style>
</head>
<body>
    <!-- 图片加载 -->
    <div id="demo">
        <img src="" alt="">
    </div>

    <!-- 模拟上传 -->
    <div id="show">yang</div>
    <button type="bg">add greenBg</button>
    <button type="cl">add buleColor</button>
    <button type="fs">add fontSize</button>
    <button type="fw">add fontWeight</button>
    <button type="op">add opacity</button>

    <!-- 保护代理 表单验证 -->
    <div>
        用户名：<input type="text" id='userDom' name="username" />
        <span id='showUser'></span>
        密码：<input type="password" id="psDom" name='code' />
        <span id="showCode"></span>
        邮箱：<input type="text" id="emDom" name='email' />
        <span id="showEm"></span>
        <button id="submit">提交</button>
    </div>
    <script>
        // 预加载
        // 懒加载 监控真正要展示的图片 是否被加载成功
        // 虚拟代理
        function MyImage(_id) {
            var oImg = document.createElement('img');
            this.setSrc = function(_src) {
                oImg.src = _src;
            }
            document.getElementById(_id).appendChild(oImg)
        }

        // new MyImage('demo').setSrc('https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=1138935709,3573339285&fm=26&gp=0.jpg')
        var ProxyImage = (function(src) {
            var oImg = new Image();
            var oMyImage = new MyImage('demo');
            oImg.onload = function(){
                setTimeout(function() {
                    oMyImage.setSrc(oImg.src)
                }, 2000)
            }
            return function(occupySrc ,src) {
                oImg.src = src
                oMyImage.setSrc(occupySrc)
            }
        })()
        ProxyImage('https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=1138935709,3573339285&fm=26&gp=0.jpg', 'https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=350713752,2792463338&fm=26&gp=0.jpg');


        // 模拟上传
        var oDiv = document.getElementById('show');
        var oButtonArray = document.getElementsByTagName('button');

        var ProxyRequest = function(func) {
            var cache = [];
            var timer = null;
            return function() {
                cache.push(this.getAttribute('type'))
                clearTimeout(timer);
                timer = setTimeout(function() {
                    func(oDiv, cache)
                    cache = []
                }, 2000)
            }
        }

        var realChangeStyle = ProxyRequest(changeStyle)

        for (var i = 0; i < oButtonArray.length; i++) {
            oButtonArray[i].onclick = realChangeStyle
            // oButtonArray[i].onclick = function() {
                // changeStyle(oDiv, this.getAttribute('type'))
            // }
        }

        function changeStyle(dom, type) {
            var typeObj = {
                bg: ['backgroundColor', 'green'],
                cl: ['color', 'blue'],
                fs: ['fontSize', '24px'],
                fw: ['fontWeight', 'bold'],
                op: ['opacity', '0.3']
            }
            if (type.constructor == Array) {
                type.forEach(function(ele) {
                    dom.style[typeObj[ele][0]] = typeObj[ele][1]
                })
            } else {
                dom.style[typeObj[type][0]] = typeObj[type][1]
            }
        }
        // changeStyle(oDiv, ['bg', 'op', 'fs'])

        // 保护代理 表单验证
        // 密码不能为空 长度不能小于6

        // 传统方法
        // var flag = true
        // submit.onclick = function() {
        //     if (userDom.value == '') {
        //         flag = false
        //         showUser.innerText = '用户名不能为空'
        //     } else if (userDom.value.length > 4) {
        //         flag = false
        //         showUser.innerText = '用户名长度大于4'
        //     }
        //     if (psDom.value == '') {
        //         flag = false
        //         showCode.innerText = '密码不能为空'
        //     } else if(psDom.value.length < 6) {
        //         flag = false
        //         showCode.innerText = '密码长度不能小于6'
        //     }
        //     if (flag) {
        //         console.log('发送网络请求')
        //     }
        // }

        // 代理模式
        function Validator() {
            this.arr = []
            this.warnDom = []
        }

        Validator.prototype.strategies = {
            isNonEmpty: function(value, errorMsg) {
                if (value == '') {
                    return errorMsg
                }
                return true
            },
            maxLength: function(value, length, errorMsg) {
                if (value != '' && value.length > length) {
                    return errorMsg
                }
                return true
            },
            minLength: function(value, length, errorMsg) {
                if (value != '' && value.length < length) {
                    return errorMsg
                }
                return true
            }
        }

        Validator.prototype.add = function(dom, showDom, strategyArr) {
            var self = this
            this.warnDom.push(showDom)
            strategyArr.forEach(function(ele, index) {
                self.arr.push(function() {
                    var list = ele.strategy.split(':')
                    var type = list.shift()
                    list.unshift(dom.value)
                    list.push(ele.errorMsg)

                    var msg = self.strategies[type].apply(self, list)
                    if (msg != true) {
                        showDom.innerText = msg
                    }
                    return msg
                })
                // self.arr[index]()
                // console.log(self.arr)
            })
        }

        Validator.prototype.start = function() {
            var flag = true;
            this.warnDom.forEach(function(ele) {
                ele.innerText = ''
            })
            this.arr.forEach(function(ele) {
                console.log(ele())
                if (ele() !== true) {
                    flag = false
                }
            })
            return flag
        }

        Validator.prototype.extend = function(config) {
            for (var prop in config) {
                Validator.prototype.strategies[prop] = config[prop]
            }
        }

        var validator = new Validator()

        var ProxyValidator = (function() {
            validator.add(userDom, showUser, [{strategy: 'isNonEmpty', errorMsg: '用户名不能为空'},{strategy: 'maxLength:4', errorMsg: '用户名不能超过4'}])
            validator.add(psDom, showCode, [{strategy: 'isNonEmpty', errorMsg: '密码不能为空'}, {strategy: 'minLength:6', errorMsg: '用户名不能小于6'}])
            validator.add(emDom, showEm, [{strategy: 'isNonEmpty', errorMsg: '邮箱不能为空'}, {strategy: 'isEmail', errorMsg: '邮箱格式不正确'}])
            return function() {
                console.log(validator)
                if (validator.start() == true) {
                    console.log('发送请求')
                }
            }
        })()
        validator.extend({
            isEmail: function(value, errorMsg) {
                if (value != '' && value.indexOf('@') == -1) {
                    return errorMsg
                }
                return true
            },
            isPhone: function(value, errorMsg) {
                if (value != '' && value.length !== 11) {
                    return errorMsg
                }
                return true
            }
        })
        submit.onclick = ProxyValidator
    </script>
</body>
</html>